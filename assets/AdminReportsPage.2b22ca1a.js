import{ar as _,as as p,r as A,o as b,a4 as C,w,d as g,f as S,e as m,c as H,a as k,Q as y}from"./index.f1a819d2.js";import{u as M}from"./pageHeader.e61d5608.js";import{E as x,D as R}from"./position-engine.8d33d564.js";import{a as $,Q as j}from"./QTable.23c3e079.js";import"./focus-manager.d3091833.js";import"./use-key-composition.9fa1f645.js";const F=_("attendanceTest",{state:()=>({}),getters:{},actions:{formatDate(t){const e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${s}`},getAndCheckDateRangesForCurrentMonth(){const t=new Date,e=t.getFullYear(),n=t.getMonth(),s=new Date(e,n,1),c=new Date(e,n,15),o=new Date(e,n,16),i=new Date(e,n+1,0),d={firstHalf:{start:this.formatDate(s),end:this.formatDate(c)},secondHalf:{start:this.formatDate(o),end:this.formatDate(i)}},a=this.formatDate(t),r=new Date(d.firstHalf.start),l=new Date(d.firstHalf.end),f=new Date(d.secondHalf.start),u=new Date(d.secondHalf.end);let h,D;return t>=r&&t<=l?(h=this.formatDate(r),D=this.formatDate(l)):t>=f&&t<=u?(h=this.formatDate(f),D=this.formatDate(u)):(h="out of range",D="out of range"),{todayDate:a,startDate:h,endDate:D}},async checkAdjustmentSalary(){try{const{count:t,error:e}=await p.from("adjustment_salary").select("*",{count:"exact",head:!0}).eq("employee_id","75bfee88-fb93-45dd-8723-9f52916cd3ab").eq("date_start","2024-08-16").eq("date_end","2024-08-31");if(console.log("Checking Adjustment Salary"),e)throw e;return console.log(t),t}catch(t){return console.log(t),0}},async createAdjustmentSalary(){let{todayDate:t,startDate:e,endDate:n}=this.getAndCheckDateRangesForCurrentMonth();console.log(t,e,n);try{const{data:s,error:c}=await p.from("adjustment_salary").insert({employee_id:"75bfee88-fb93-45dd-8723-9f52916cd3ab",date_start:e,date_end:n}).select();if(console.log("Created Adjustment Salary"),c)throw c;return console.log(s[0].id),s[0].id}catch(s){console.log(s)}},async inputAttendance(t){try{const e=new Date,{data:n,error:s}=await p.from("attendance").insert({adjustment_salary_id:t,employee_id:"75bfee88-fb93-45dd-8723-9f52916cd3ab",time_in:"08:00:00",time_out:"16:00:00",date:this.formatDate(e)}).select();if(console.log("Input Attendance"),s)throw s;console.log(n)}catch(e){console.log(e)}},async processAttendance(){try{const t=await this.checkAdjustmentSalary();if(t===0){const e=await this.createAdjustmentSalary();await this.inputAttendance(e)}else await this.inputAttendance(t)}catch(t){console.error("An error occurred:",t)}}}}),O=_("attendanceTable",{state:()=>({rows:[],selectedDate:null,selectedDateOptions:null,attendanceColumns:{columns:[]}}),getters:{getSelectedDate(){return this.selectedDate}},actions:{formatDate(t){const e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${s}`},getAndCheckDateRangesForCurrentMonth(){const t=new Date,e=t.getFullYear(),n=t.getMonth(),s=new Date(e,n,1),c=new Date(e,n,15),o=new Date(e,n,16),i=new Date(e,n+1,0),d={firstHalf:{start:this.formatDate(s),end:this.formatDate(c)},secondHalf:{start:this.formatDate(o),end:this.formatDate(i)}},a=this.formatDate(t),r=new Date(d.firstHalf.start),l=new Date(d.firstHalf.end),f=new Date(d.secondHalf.start),u=new Date(d.secondHalf.end);let h,D;return t>=r&&t<=l?(h=this.formatDate(r),D=this.formatDate(l)):t>=f&&t<=u?(h=this.formatDate(f),D=this.formatDate(u)):(h="out of range",D="out of range"),{todayDate:a,startDate:h,endDate:D}},async getSalaryHistory(){try{const{data:t,error:e}=await p.from("salary_history").select();e&&console.error(e),this.selectedDateOptions=t}catch(t){console.error(t)}},fillMissingDates(t,e,n){const s=i=>{const d=i.getFullYear(),a=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0");return`${d}-${a}-${r}`},c=new Date(e),o=new Date(n);for(const i in t){const d=new Set(t[i].map(r=>r.date));let a=new Date(c);for(;a<=o;){const r=s(a);d.has(r)||t[i].push({id:null,adjustment_salary_id:null,employee_id:i,time_in:null,time_out:null,remarks:null,date:r,employee:{last_name:null,first_name:null,middle_name:null}}),a.setDate(a.getDate()+1)}t[i].sort((r,l)=>new Date(r.date)-new Date(l.date))}return t},async fetchAttendanceInRange(t=this.selectedDate.date_start,e=this.selectedDate.date_end){try{const{data:n,error:s}=await p.from("attendance").select(`
            *,
            employee:employee_id (
              first_name,
              last_name,
              middle_name
            )
          `).gte("date",t).lte("date",e);if(s)console.error("Error fetching data:",s);else{const c=n.reduce((o,i)=>(o[i.employee_id]||(o[i.employee_id]=[]),o[i.employee_id].push(i),o),{});this.rows=Object.values(this.fillMissingDates(c,t,e))}}catch(n){console.error(n)}},columns(t=this.selectedDate.date_start,e=this.selectedDate.date_end){const n=new Date(t),s=new Date(e),c=[],o={day:"numeric",month:"numeric"};let i=0;for(let a=new Date(n);a<=s;a.setDate(a.getDate()+1)){const r=a.getDate(),l=new Intl.DateTimeFormat("en-US",o).format(a);c.push((()=>{const f=i;return{name:`${r}`,align:"center",label:`${l}`,sortable:!0,field:u=>u[f]&&u[f].time_in&&u[f].time_out?u[f].date:"Absent",classes:u=>u[f]&&u[f].time_in&&u[f].time_out?"!tw-bg-[#82ff72ad] !tw-w-[50px] !tw-h-[50px] tw-rounded-lg":"!tw-bg-[#ff8787b0] !tw-w-[50px] !tw-h-[50px] tw-rounded-lg"}})()),i++}const d=[{name:"employeeName",align:"center",label:"Name",sortable:!0,field:a=>a[1].employee.last_name+", "+a[1].employee.first_name+" "+a[1].employee.middle_name[1]+".",format:a=>`${a}`},...c,{name:"totalPresent",align:"center",label:"P",sortable:!0,field:a=>{let r=0;for(let l=0;l<a.length;l++)a[l].time_in&&a[l].time_out&&a[l].date&&r++;return r}},{name:"totalAbsent",align:"center",label:"A",sortable:!0,field:a=>{let r=0;for(let l=0;l<a.length;l++)a[l]&&a[l].time_in&&a[l].time_out||r++;return r}},{name:"totalLeave",align:"center",label:"LVE",sortable:!0}];this.attendanceColumns.columns.push(...d)},getNearestDateRange(){if(this.selectedDate!=null)return;const t=new Date;function e(o){return new Date(o)}function n(o){return Math.abs(t-o)}let s=null,c=1/0;for(const o of this.selectedDateOptions){const i=e(o.date_start),d=e(o.date_end),a=n(i),r=n(d),l=Math.min(a,r);l<c&&(c=l,s=o)}this.selectedDate=s},async fetchAttendanceReports(){this.attendanceColumns.columns=[],await this.getSalaryHistory(),this.getNearestDateRange(),this.columns(),this.fetchAttendanceInRange()}}}),T={__name:"AttendanceTable",setup(t){const e=O(),n=A("");return e.fetchAttendanceReports(),(s,c)=>(b(),C(j,{class:"tw-border tw-rounded-3xl tw-shadow-lg",flat:"",bordered:"",dense:"",title:"Attendance Report","title-class":["tw-text-xl","tw-font-bold"],filter:n.value,columns:m(e).attendanceColumns.columns,rows:m(e).rows,"rows-per-page-options":[0],separator:"cell","row-key":"name"},{"top-left":w(()=>[g($,{filled:"",modelValue:m(e).selectedDate,"onUpdate:modelValue":[c[0]||(c[0]=o=>m(e).selectedDate=o),c[1]||(c[1]=o=>m(e).fetchAttendanceReports())],"use-input":"","hide-selected":"","fill-input":"","hide-bottom-space":"","input-debounce":"0",options:m(e).selectedDateOptions,"option-label":o=>o.date_start+" "+o.date_end,class:"!tw-pb-0"},{"no-option":w(()=>[g(x,null,{default:w(()=>[g(R,{class:"text-grey"},{default:w(()=>[S(" No results ")]),_:1})]),_:1})]),_:1},8,["modelValue","options","option-label"])]),_:1},8,["filter","columns","rows"]))}},E={class:"tw-w-12/12 tw-max-w-full tw-mx-auto tw-bg-white tw-shadow-lg tw-border tw-rounded-3xl tw-border-collapse tw-p-4 tw-mt-0"},P={__name:"AdminReportsPage",setup(t){const e=F(),n=M();return n.currentPage="Reports",(s,c)=>(b(),H("div",E,[k("div",null,[g(T),S(" \xA0 "),g(y,{icon:"mdi-plus",label:"Check Date Ranges for Current Month",onClick:m(e).getAndCheckDateRangesForCurrentMonth,class:"tw-bg-white"},null,8,["onClick"]),g(y,{icon:"mdi-plus",label:"Adjustment Salary",onClick:m(e).checkAdjustmentSalary,class:"tw-bg-white"},null,8,["onClick"]),g(y,{icon:"mdi-plus",label:"createAdjustmentSalary",onClick:m(e).createAdjustmentSalary,class:"tw-bg-white"},null,8,["onClick"]),g(y,{icon:"mdi-plus",label:"createAdjustmentSalary",onClick:m(e).processAttendance,class:"tw-bg-white"},null,8,["onClick"])])]))}};export{P as default};
