import{Q as $}from"./QTd.8e3ba709.js";import{ar as B,as as p,r as h,o as v,c as w,d as i,Q as f,w as d,a as s,f as V,a5 as _,e as u,g as Q,V as y,a4 as A,n as U,a7 as q,G as I,u as O,aH as P}from"./index.2557495e.js";import{Q as b}from"./QInput.9f633af0.js";import{Q as R,a as C}from"./QTable.bf8134d5.js";import{u as T}from"./pageHeader.15e9386d.js";import{Q as x,C as g}from"./ClosePopup.35a1fdfa.js";import{Q as D,E as S,D as k}from"./position-engine.76115753.js";import{Q as F}from"./QCardSection.083e5042.js";import{Q as N}from"./QForm.a51a9248.js";import{Q as z}from"./QCard.2519de4b.js";import"./use-key-composition.e05cac7d.js";import"./focus-manager.d822a2e9.js";const L=B("viewLoan",{state:()=>({rows:[],paymentButton:!1,payment:null}),getters:{getArchivedLoanList(t){return t.rows.filter(e=>e.is_archive)},getUnarchivedLoanList(t){return t.rows.filter(e=>!e.is_archive)}},actions:{async getLoanList(){const{data:t,error:e}=await p.from("request").select(`
        id,
    employee_id,
    employee (
      id,
      first_name,
      last_name
    ),
    request_type_id,
    request_confirmation_id,
    request_date,
    description,
    remarks,
    is_archive,
    request_type (
        id,
        request_type_name
    ),
    request_confirmation (
        id,
        employee_id,
        application_date,
        request_confirmation_date,
        status,
        remarks,
        is_archive,
        employee (
            id,
            first_name,
            last_name
        )
    ),
    vale (
        id,
        request_id,
        amount,
        balance,
        date,
        is_archive
    ),
    partial_to_ar(
        id,
        request_id,
        amount,
        balance,
        date,
        is_archive
    )
  `);if(e)throw e;return this.rows=t.filter(r=>r.request_type_id===1||r.request_type_id===2),t},async archivedLoan(t,e,r,a,c,l,o){try{await this.archivedRequest(a,c),await this.archivedRequestConfirmation(l,o);const{error:n}=await p.from(e).update({is_archive:!r}).eq("id",t);if(n)throw n;this.getLoanList()}catch(n){console.log(n)}},async archivedRequest(t,e){try{const{error:r}=await p.from("request").update({is_archive:!e}).eq("id",t);if(r)throw r}catch(r){console.log(r)}},async archivedRequestConfirmation(t,e){try{const{error:r}=await p.from("request_confirmation").update({is_archive:!e}).eq("id",t);if(r)throw r}catch(r){console.log(r)}},async insertPayment(t){if(t.vale.length>0){console.log(t.vale[0].id),console.log(t.vale[0].balance);const{data:e}=await p.from("vale").update({balance:t.vale[0].balance-this.payment}).select().eq("id",t.vale[0].id);console.log(e)}else t.partial_to_ar.length>0&&console.log("The partial_to_ar array is empty.")}}});const W={class:"!tw-h-min !tw-w-5/12 !tw-max-w-full tw-bg-white tw-p-6"},H={id:"section-to-print"},j={class:"tw-text-3xl tw-font-extrabold tw-pb-3"},G=s("br",null,null,-1),M={class:"tw-text-base tw-font-normal tw-text-gray-500"},J={class:"tw-w-full tw-table-auto tw-border-collapse"},K=s("td",null,null,-1),X=s("td",null,null,-1),Y=s("td",null,null,-1),Z={key:0},E={__name:"ViewLoanButton",props:["rows"],setup(t){const e=L(),r=h(!1),a=h(null);function c(o){a.value=o,r.value=!0}function l(o){return o.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}return(o,n)=>(v(),w(q,null,[i(f,{style:{"flex-wrap":"nowrap !important"},icon:"visibility",label:"VIEW",onClick:n[0]||(n[0]=m=>c(t.rows))}),i(D,{modelValue:r.value,"onUpdate:modelValue":n[6]||(n[6]=m=>r.value=m),persistent:""},{default:d(()=>[s("div",W,[s("div",H,[s("div",j,[V(" Loan ID - "+_(a.value.id)+" ",1),G,s("span",M,_(a.value.request_type.request_type_name)+" - "+_(a.value.vale&&a.value.vale.length>0?a.value.vale[0].id:a.value.partial_to_ar[0].id),1)]),s("table",J,[s("tr",null,[s("td",null," Recipient: "+_(a.value.id)+" - "+_(a.value.employee.last_name)+", "+_(a.value.employee.first_name),1),s("td",null," Issuer: "+_(a.value.request_confirmation.employee.last_name)+", "+_(a.value.request_confirmation.employee.first_name),1)]),s("tr",null,[K,s("td",null," Amount: "+_(a.value.request_type.request_type_name==="VALE"?l(a.value.vale[0].amount):l(a.value.partial_to_ar[0].amount)),1)]),s("tr",null,[X,s("td",null," Balance: "+_(a.value.request_type.request_type_name==="VALE"?l(a.value.vale[0].balance):l(a.value.partial_to_ar[0].balance)),1)]),s("tr",null,[Y,u(e).paymentButton===!0?(v(),w("td",Z,[i(b,{modelValue:u(e).payment,"onUpdate:modelValue":n[1]||(n[1]=m=>u(e).payment=m)},null,8,["modelValue"])])):Q("",!0)])])]),i(x,{align:"right",class:"text-primary noPrint"},{default:d(()=>[y(i(f,{flat:"",label:"Cancel",onClick:n[2]||(n[2]=m=>u(e).paymentButton=!1)},null,512),[[g]]),u(e).paymentButton===!1?(v(),A(f,{key:0,label:"Payment",onClick:n[3]||(n[3]=m=>u(e).paymentButton=!0)})):(v(),A(f,{key:1,label:"Save",onClick:n[4]||(n[4]=m=>{u(e).paymentButton=!1,u(e).insertPayment(a.value)})})),y(i(f,{flat:"",class:U(a.value.vale&&a.value.vale.length>0?a.value.vale[0].is_archive?"tw-bg-green-400":"tw-bg-red-400":a.value.partial_to_ar[0].is_archive?"tw-bg-green-400":"tw-bg-red-400"),icon:"mdi-archive",label:a.value.vale&&a.value.vale.length>0?a.value.vale[0].is_archive?"Unarchive":"Archive":a.value.partial_to_ar[0].is_archive?"Unarchive":"Archive",onClick:n[5]||(n[5]=m=>u(e).archivedLoan(a.value.vale&&a.value.vale.length>0?a.value.vale[0].id:a.value.partial_to_ar[0].id,a.value.vale&&a.value.vale.length>0?"vale":"partial_to_ar",a.value.vale&&a.value.vale.length>0?a.value.vale[0].is_archive:a.value.partial_to_ar[0].is_archive,a.value.id,a.value.is_archive,a.value.request_confirmation.id,a.value.request_confirmation.is_archive))},null,8,["class","label"]),[[g]])]),_:1})])]),_:1},8,["modelValue"])],64))}},ee={class:"!tw-h-min !tw-w-8/12 !tw-max-w-full tw-bg-white tw-p-6"},te=s("div",{class:"tw-col-span-4 tw-text-3xl tw-font-extrabold tw-pb-3"}," Archived Loan ",-1),ae={__name:"ArchivedLoanButton",setup(t){const e=L(),r=h(!1),a=h("");function c(o){return o.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}const l=[{name:"Loan ID",required:!0,label:"Loan ID",align:"left",field:o=>o.id,format:o=>`${o}`,sortable:!0},{name:"Loan Type",align:"center",label:"Loan Type",field:o=>(o.request_type.request_type_name==="VALE"?o.vale[0].id:o.partial_to_ar[0].id)+" - "+o.request_type.request_type_name,format:o=>`${o}`,sortable:!0},{name:"Description",align:"center",label:"Description",field:"description",sortable:!0},{name:"Recipient",align:"center",label:"Recipient",field:o=>o.employee.first_name+" "+o.employee.last_name,sortable:!0},{name:"Issuer",align:"center",label:"Issuer",field:o=>o.request_confirmation.employee.first_name+" "+o.request_confirmation.employee.last_name,sortable:!0},{name:"Amount",align:"center",label:"Amount",field:o=>"\u20B1"+(o.request_type.request_type_name==="VALE"?c(o.vale[0].amount):c(o.partial_to_ar[0].amount)),sortable:!0},{name:"actions",align:"center",label:"",field:""}];return(o,n)=>(v(),w(q,null,[i(f,{icon:"mdi-archive",label:"Archived Loan",onClick:n[0]||(n[0]=m=>r.value=!0),class:"tw-bg-white"}),i(D,{modelValue:r.value,"onUpdate:modelValue":n[2]||(n[2]=m=>r.value=m),persistent:""},{default:d(()=>[s("div",ee,[te,i(R,{class:"my-sticky-header-table tw-w-11/12 tw-mx-auto tw-mt-6 tw-bg-white tw-shadow-lg tw-border tw-rounded-3xl tw-border-collapse",flat:"",bordered:"",filter:a.value,columns:l,rows:u(e).getArchivedLoanList,"rows-per-page-options":[10,20,0],"row-key":"name"},{"body-cell-actions":d(m=>[i($,{props:m},{default:d(()=>[s("div",null,[i(E,{rows:m.row},null,8,["rows"])])]),_:2},1032,["props"])]),"top-right":d(()=>[i(b,{borderless:"",dense:"",debounce:"300",modelValue:a.value,"onUpdate:modelValue":n[1]||(n[1]=m=>a.value=m),placeholder:"Search"},{append:d(()=>[i(I,{name:"search"})]),_:1},8,["modelValue"])]),_:1},8,["filter","rows"]),i(x,{align:"right",class:"text-primary"},{default:d(()=>[y(i(f,{flat:"",label:"Cancel"},null,512),[[g]])]),_:1})])]),_:1},8,["modelValue"])],64))}},le=O(),oe=L(),ie=B("addLoan",{state:()=>({employee_id:le.getEmployeeId,employeeOption:null,employeeOptions:null,type:null,typeOptions:["Vale","Partial to A/R"],description:null,amount:null,insertRequestConfirmationID:null,insertRequestID:null,disableButtonExisting:!1}),getters:{},actions:{async getDetails(){try{const{data:t,error:e}=await p.from("employee").select();if(e)throw e;this.employeeOptions=t}catch(t){console.log(t)}},addLoan(){this.insertRequestConfirmation().then(()=>this.insertRequest()).then(()=>this.insertCompanyLoan()).then(()=>{this.resetForm()}).then(()=>{oe.getLoanList()}).catch(t=>{console.error("An error occurred:",t)})},async insertRequestConfirmation(){try{const{data:t,error:e}=await p.from("request_confirmation").insert([{employee_id:this.employee_id,application_date:new Date().toLocaleDateString("en-US"),request_confirmation_date:new Date().toLocaleDateString("en-US"),status:"Approved",remarks:"Approved",is_archive:!1}]).select("id");if(e)throw e;console.log(t[0].id),this.insertRequestConfirmationID=t[0].id}catch(t){alert(t+"line 66"),console.log(t)}},async insertRequest(){try{const{data:t,error:e}=await p.from("request").insert([{employee_id:this.employeeOption.id,request_type_id:this.type=="Vale"?1:2,request_confirmation_id:this.insertRequestConfirmationID,request_date:new Date().toLocaleDateString("en-US"),description:this.description,remarks:"Pending",is_archive:!1}]).select("id");if(e)throw e;console.log("Insert Request ID",t[0].id),this.insertRequestID=t[0].id}catch(t){alert(t+"line 94"),console.log(t)}},async insertCompanyLoan(){try{if(this.type=="Vale"){const{data:t,error:e}=await p.from("vale").insert([{request_id:this.insertRequestID,employee_id:this.employeeOption.id,amount:this.amount,balance:this.amount,emp_id_modified_by:this.employee_id,date:new Date().toLocaleDateString("en-US"),is_archive:!1}]);if(e)throw e;console.log("data",t)}else{const{data:t,error:e}=await p.from("partial_to_ar").insert([{request_id:this.insertRequestID,employee_id:this.employeeOption.id,amount:this.amount,balance:this.amount,emp_id_modified_by:this.employee_id,date:new Date().toLocaleDateString("en-US"),is_archive:!1}]);if(e)throw e;console.log("data",t)}}catch(t){alert(t+"line 131"),console.log(t)}},async checkValidity(){try{if(this.type=="Partial to A/R"){const{data:t,error:e}=await p.from("partial_to_ar").select().eq("employee_id",this.employeeOption.id);if(t.length>0?(alert("Employee already has an existing Partial To A/R"),this.disableButtonExisting=!0):this.disableButtonExisting=!1,e)throw e;console.log("data ar",t)}else if(this.type=="Vale"){const{data:t,error:e}=await p.from("vale").select().eq("employee_id",this.employeeOption.id);if(t.length>0?(alert("Employee already has an existing vale"),this.disableButtonExisting=!0):this.disableButtonExisting=!1,e)throw e;console.log("data vale",t)}else this.disableButtonExisting=!1}catch(t){alert(t+"line 142"),console.log(t)}},resetForm(){this.employeeOption=null,this.type=null,this.description=null,this.amount=null}}}),ne={class:"tw-m-4"},se=s("div",{class:"tw-text-3xl tw-font-extrabold tw-pb-3"}," Add Loan Form ",-1),re={class:"tw-flex tw-mb-3"},ue=s("div",{class:"tw-content-center tw-mr-3"},"Employee Name:",-1),de={class:"tw-flex tw-mb-3"},me=s("div",{class:"tw-content-center tw-mr-3"},"Type:",-1),ce=s("div",null,"Description:",-1),pe={class:"tw-pb-3 tw-px-2"},_e={class:"tw-flex tw-mb-3"},fe=s("div",{class:"tw-content-center tw-mr-3"},"Amount:",-1),ve={class:"tw-px-2"},he={__name:"AddLoanButton",setup(t){const e=ie(),r=h(!1);e.getDetails();function a(c,l){l(()=>{console.log(c);const o=c.toLowerCase();e.selectorEmployeeOptions=e.employeeOptions.filter(n=>String(n.company_employee_id).toLowerCase().indexOf(o)>-1)})}return(c,l)=>(v(),w(q,null,[i(f,{icon:"mdi-plus",label:"Add Loan",onClick:l[0]||(l[0]=o=>r.value=!0),class:"tw-bg-white"}),i(D,{modelValue:r.value,"onUpdate:modelValue":l[5]||(l[5]=o=>r.value=o),persistent:""},{default:d(()=>[i(z,{class:"min-width: 500px"},{default:d(()=>[i(N,{onSubmit:P(u(e).addLoan,["prevent"]),autofocus:""},{default:d(()=>[s("div",ne,[i(F,{class:"tw-pt-0 tw-pl-0"},{default:d(()=>[se]),_:1}),s("div",re,[ue,i(C,{filled:"",modelValue:u(e).employeeOption,"onUpdate:modelValue":[l[1]||(l[1]=o=>u(e).employeeOption=o),u(e).checkValidity],"use-input":"","hide-selected":"","fill-input":"","hide-bottom-space":"","input-debounce":"0",options:u(e).selectorEmployeeOptions,"option-label":o=>"first_name"in o?o.company_employee_id+" - "+o.last_name:"",onFilter:a,"option-value":c.id,class:"!tw-pb-0; tw-capitalize","popup-content-class":"tw-capitalize"},{"no-option":d(()=>[i(S,null,{default:d(()=>[i(k,{class:"text-grey"},{default:d(()=>[V(" No results ")]),_:1})]),_:1})]),_:1},8,["modelValue","options","option-label","option-value","onUpdate:modelValue"])]),s("div",de,[me,i(C,{filled:"",modelValue:u(e).type,"onUpdate:modelValue":[l[2]||(l[2]=o=>u(e).type=o),u(e).checkValidity],"use-input":"","hide-selected":"","fill-input":"","hide-bottom-space":"","input-debounce":"0",options:u(e).typeOptions,class:"!tw-pb-0; tw-capitalize;","popup-content-class":"tw-capitalize"},{"no-option":d(()=>[i(S,null,{default:d(()=>[i(k,{class:"text-grey"},{default:d(()=>[V(" No results ")]),_:1})]),_:1})]),_:1},8,["modelValue","options","onUpdate:modelValue"])]),s("div",null,[ce,s("div",pe,[i(b,{modelValue:u(e).description,"onUpdate:modelValue":l[3]||(l[3]=o=>u(e).description=o),type:"textarea",filled:"","hide-bottom-space":""},null,8,["modelValue"])])]),s("div",_e,[fe,s("div",ve,[i(b,{modelValue:u(e).amount,"onUpdate:modelValue":l[4]||(l[4]=o=>u(e).amount=o),filled:"",autogrow:"","hide-bottom-space":"",class:"tw-max-w-full"},null,8,["modelValue"])])]),i(x,{align:"right",class:"text-primary"},{default:d(()=>[y(i(f,{flat:"",label:"Cancel",onClick:c.resetForm},null,8,["onClick"]),[[g]]),y(i(f,{flat:"",class:"tw-bg-green-400",label:"Add Loan",type:"submit",disable:u(e).disableButtonExisting},null,8,["disable"]),[[g]])]),_:1})])]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue"])],64))}},we={class:"tw-w-11/12 tw-mx-auto tw-flex tw-justify-end tw-mb-5 tw-gap-4"},$e={__name:"AdminLoanListPage",setup(t){const e=T();e.currentPage="Loan List";const r=L();r.getLoanList();function a(l){return l.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}const c=[{name:"Loan ID",required:!0,label:"Loan ID",align:"left",field:l=>l.id,format:l=>`${l}`,sortable:!0},{name:"Loan Type",align:"center",label:"Loan Type",field:l=>(l.request_type.request_type_name==="VALE"?l.vale[0].id:l.partial_to_ar[0].id)+" - "+l.request_type.request_type_name,format:l=>`${l}`,sortable:!0},{name:"Description",align:"center",label:"Description",field:"description",sortable:!0},{name:"Recipient",align:"center",label:"Recipient",field:l=>l.employee.first_name+" "+l.employee.last_name,sortable:!0},{name:"Issuer",align:"center",label:"Issuer",field:l=>l.request_confirmation.employee.first_name+" "+l.request_confirmation.employee.last_name,sortable:!0},{name:"Amount",align:"center",label:"Amount",field:l=>"\u20B1"+(l.request_type.request_type_name==="VALE"?a(l.vale[0].balance)+" / \u20B1"+a(l.vale[0].amount):a(l.partial_to_ar[0].balance)+" / \u20B1"+a(l.partial_to_ar[0].amount)),sortable:!0},{name:"actions",align:"center",label:"",field:""}];return(l,o)=>(v(),w(q,null,[s("div",we,[i(ae),i(he)]),i(R,{class:"my-sticky-header-table tw-w-11/12 tw-mx-auto tw-mt-6 tw-bg-white tw-shadow-lg tw-border tw-rounded-3xl tw-border-collapse",flat:"",bordered:"",filter:l.tableSearch,columns:c,rows:u(r).getUnarchivedLoanList,"rows-per-page-options":[10,20,0],"row-key":"Loan ID"},{"body-cell-actions":d(n=>[i($,{key:"actions",class:"tw-w-2/12",props:n},{default:d(()=>[i(E,{rows:n.row},null,8,["rows"])]),_:2},1032,["props"])]),"top-right":d(()=>[i(b,{borderless:"",dense:"",debounce:"300",modelValue:l.tableSearch,"onUpdate:modelValue":o[0]||(o[0]=n=>l.tableSearch=n),placeholder:"Search"},{append:d(()=>[i(I,{name:"search"})]),_:1},8,["modelValue"])]),_:1},8,["filter","rows"])],64))}};export{$e as default};
